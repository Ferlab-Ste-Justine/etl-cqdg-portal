args=[]
sources=[
#     #################### PATIENT ##################
#     {
#         format=AVRO
#         id="raw_patient"
#         keys=[]
#         loadtype=OverWrite
#         partitionby=[
#             "study_id",
#             "release_id"
#         ]
#         path="/fhir/patient"
#         readoptions {}
#         storageid=storage
#         table {
#             database=normalized
#             name="raw_patient"
#         }
#         writeoptions {
#             "created_on_column"="created_on"
#             "updated_on_column"="updated_on"
#             "valid_from_column"="valid_from"
#             "valid_to_column"="valid_to"
#         }
#     },
#     {
#         format=DELTA
#         id="normalized_patient"
#         keys=[]
#         loadtype=OverWritePartition
#         partitionby=[
#             "study_id",
#             "release_id"
#         ]
#         path="/normalized/patient"
#         readoptions {}
#         storageid=storage
# #         table {
# #             database=normalized
# #             name=patient
# #         }
#         writeoptions {
#             "created_on_column"="created_on"
#             overwriteSchema="true"
#             "updated_on_column"="updated_on"
#             "valid_from_column"="valid_from"
#             "valid_to_column"="valid_to"
#         }
#     },
#     #################### DIAGNOSIS ##################
#      {
#             format=AVRO
#             id="raw_diagnosis"
#             keys=[]
#             loadtype=OverWrite
#             partitionby=[
#                 "study_id",
#                 "release_id"
#             ]
#             path="/fhir/condition"
#             readoptions {}
#             storageid=storage
#             table {
#                 database=normalized
#                 name="raw_diagnosis"
#             }
#             writeoptions {
#                 "created_on_column"="created_on"
#                 "updated_on_column"="updated_on"
#                 "valid_from_column"="valid_from"
#                 "valid_to_column"="valid_to"
#             }
#         },
#         {
#             format=DELTA
#             id="normalized_diagnosis"
#             keys=[]
#             loadtype=OverWritePartition
#             partitionby=[
#                 "study_id",
#                 "release_id"
#             ]
#             path="/normalized/diagnosis"
#             readoptions {}
#             storageid=storage
#     #         table {
#     #             database=normalized
#     #             name=diagnosis
#     #         }
#             writeoptions {
#                 "created_on_column"="created_on"
#                 overwriteSchema="true"
#                 "updated_on_column"="updated_on"
#                 "valid_from_column"="valid_from"
#                 "valid_to_column"="valid_to"
#             }
#         },
        #################### PHENOTYPE ##################
#         {
#             format=AVRO
#             id="raw_phenotype"
#             keys=[]
#             loadtype=OverWrite
#             partitionby=[
#                 "study_id",
#                 "release_id"
#             ]
#             path="/fhir/observation"
#             readoptions {}
#             storageid=storage
#             table {
#                 database=normalized
#                 name="raw_phenotype"
#             }
#             writeoptions {
#                 "created_on_column"="created_on"
#                 "updated_on_column"="updated_on"
#                 "valid_from_column"="valid_from"
#                 "valid_to_column"="valid_to"
#             }
#         },
#         {
#             format=DELTA
#             id="normalized_phenotype"
#             keys=[]
#             loadtype=OverWritePartition
#             partitionby=[
#                 "study_id",
#                 "release_id"
#             ]
#             path="/normalized/phenotype"
#             readoptions {}
#             storageid=storage
#         #         table {
#         #             database=normalized
#         #             name=diagnosis
#         #         }
#             writeoptions {
#                 "created_on_column"="created_on"
#                 overwriteSchema="true"
#                 "updated_on_column"="updated_on"
#                 "valid_from_column"="valid_from"
#                 "valid_to_column"="valid_to"
#             }
#         },
        #################### BIOSPECIMEN ##################
        {
            format=AVRO
            id="raw_biospecimen"
            keys=[]
            loadtype=OverWrite
            partitionby=[
                "study_id",
                "release_id"
            ]
            path="/fhir/specimen"
            readoptions {}
            storageid=storage
            table {
                database=normalized
                name="raw_biospecimen"
            }
            writeoptions {
                "created_on_column"="created_on"
                "updated_on_column"="updated_on"
                "valid_from_column"="valid_from"
                "valid_to_column"="valid_to"
            }
        },
        {
            format=DELTA
            id="normalized_biospecimen"
            keys=[]
            loadtype=OverWritePartition
            partitionby=[
                "study_id",
                "release_id"
            ]
            path="/normalized/biospecimen"
            readoptions {}
            storageid=storage
        #         table {
        #             database=normalized
        #             name=biospecimen
        #         }
            writeoptions {
                "created_on_column"="created_on"
                overwriteSchema="true"
                "updated_on_column"="updated_on"
                "valid_from_column"="valid_from"
                "valid_to_column"="valid_to"
            }
        },
        #################### SAMPLE REGISTRATION ##################
        {
            format=AVRO
            id="raw_sample_registration"
            keys=[]
            loadtype=OverWrite
            partitionby=[
                "study_id",
                "release_id"
            ]
            path="/fhir/specimen"
            readoptions {}
            storageid=storage
            table {
                database=normalized
                name="raw_sample_registration"
            }
            writeoptions {
                "created_on_column"="created_on"
                "updated_on_column"="updated_on"
                "valid_from_column"="valid_from"
                "valid_to_column"="valid_to"
            }
        },
        {
            format=DELTA
            id="normalized_sample_registration"
            keys=[]
            loadtype=OverWritePartition
            partitionby=[
                "study_id",
                "release_id"
            ]
            path="/normalized/sample_registration"
            readoptions {}
            storageid=storage
        #         table {
        #             database=normalized
        #             name=sample_registration
        #         }
            writeoptions {
                "created_on_column"="created_on"
                overwriteSchema="true"
                "updated_on_column"="updated_on"
                "valid_from_column"="valid_from"
                "valid_to_column"="valid_to"
            }
        },
#         #################### RESEARCH STUDY ##################
#         {
#             format=AVRO
#             id="raw_research_study"
#             keys=[]
#             loadtype=OverWrite
#             partitionby=[
#                 "study_id",
#                 "release_id"
#             ]
#             path="/fhir/researchstudy"
#             readoptions {}
#             storageid=storage
#             table {
#                 database=normalized
#                 name="raw_research_study"
#             }
#             writeoptions {
#                 "created_on_column"="created_on"
#                 "updated_on_column"="updated_on"
#                 "valid_from_column"="valid_from"
#                 "valid_to_column"="valid_to"
#             }
#         },
#         {
#             format=DELTA
#             id="normalized_research_study"
#             keys=[]
#             loadtype=OverWritePartition
#             partitionby=[
#                 "study_id",
#                 "release_id"
#             ]
#             path="/normalized/research_study"
#             readoptions {}
#             storageid=storage
# #             table {
# #                 database=normalized
# #                 name=sample_registration
# #             }
#             writeoptions {
#                 "created_on_column"="created_on"
#                 overwriteSchema="true"
#                 "updated_on_column"="updated_on"
#                 "valid_from_column"="valid_from"
#                 "valid_to_column"="valid_to",
#                 mergeSchema="true"
#             }
#         }
]
sparkconf {
    "spark.databricks.delta.retentionDurationCheck.enabled"="false"
    "spark.delta.merge.repartitionBeforeWrite"="true"
    "spark.fhir.server.url"="http://localhost:8080"
    "spark.hadoop.fs.s3a.access.key"=${?AWS_ACCESS_KEY}
    "spark.hadoop.fs.s3a.endpoint"=${?AWS_ENDPOINT}
    "spark.hadoop.fs.s3a.impl"="org.apache.hadoop.fs.s3a.S3AFileSystem"
    "spark.hadoop.fs.s3a.path.style.access"="true"
    "spark.hadoop.fs.s3a.secret.key"=${?AWS_SECRET_KEY}
    "spark.master"=local
    "spark.sql.catalog.spark_catalog"="org.apache.spark.sql.delta.catalog.DeltaCatalog"
    "spark.sql.extensions"="io.delta.sql.DeltaSparkSessionExtension"
    "spark.sql.legacy.timeParserPolicy"=CORRECTED
    "spark.sql.mapKeyDedupPolicy"="LAST_WIN"
}
storages=[
    {
        filesystem=S3
        id=storage
        path="s3a://cqdg-qa-app-clinical-data-service"
    }
]
